<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>jenkins로 배포하기 - nodejs-2 | jaehunpark</title>
  <meta name="author" content="jaehunpark">
  
  <meta name="description" content="jenkins로 nodejs 서버 배포하기 -  2이전 포스트 jenkins로 nodejs 서버 배포하기 -  1 를 통해 nodejs 서버를 remote 서버로 쉘스크립트 EOF를 사용하여 remote 서버에서 git clone 하여 배포하는 법을 알아보았다.이번 포">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="jenkins로 배포하기 - nodejs-2"/>
  <meta property="og:site_name" content="jaehunpark"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-97011652-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">jaehunpark</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> jenkins로 배포하기 - nodejs-2</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h2 id="jenkins로-nodejs-서버-배포하기-2"><a href="#jenkins로-nodejs-서버-배포하기-2" class="headerlink" title="jenkins로 nodejs 서버 배포하기 -  2"></a>jenkins로 nodejs 서버 배포하기 -  2</h2><p>이전 포스트 <a href="https://setyourmindpark.github.io/2017/04/22/jenkins-2/" target="_blank" rel="noopener">jenkins로 nodejs 서버 배포하기 -  1</a> 를 통해 nodejs 서버를 remote 서버로 쉘스크립트 EOF를 사용하여 remote 서버에서 git clone 하여 배포하는 법을 알아보았다.<br>이번 포스트에서는 두번째방법으로 첫번째 방법보다는 좀더 간단한 방법을 소개하려한다.<br><br><br></p>
<h2 id="쉘-스크립트-EOF-와-SCP"><a href="#쉘-스크립트-EOF-와-SCP" class="headerlink" title="쉘 스크립트 EOF 와 SCP"></a>쉘 스크립트 EOF 와 SCP</h2><p>기본적으로 쉘스크립트 EOF를 사용하여 jenkins가 remote 서버에서 control하는 기본 개념은 같다.<br>이후 첫번째방법에서는 jenkins가 remote 서버 접속후 프로젝트를 다시 clone 하여 job을 수행하는 방법이었으며, 이번에 소개해드릴방법은 jenkins가 test를 수행한 프로젝트 자체를 scp 명령어를 사용해서 remote 서버로 프로젝트를 전송하는 방법이다 .<br>jenkins [ Managed script file ] 플러그인을 다음과 같이 설정하였다.<br>jenkins관리 -&gt; Managed files -&gt; Add a new Config -&gt; Managed script file<br><img src="jenkins-3_2.png" alt="jenkins-3_2"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">npm install</div><div class="line">npm test</div><div class="line">rm -rf node_modules</div><div class="line"></div><div class="line">-#!/bin/sh</div><div class="line">ssh root@remote서버ip &lt;&lt;EOF</div><div class="line"> pm2 delete apiServer</div><div class="line"> rm -rf /root/nodejs-skeletone-v2</div><div class="line"> exit</div><div class="line">EOF</div><div class="line"></div><div class="line">scp -r ../nodejs-skeletone-v2 root@remote서버ip:/root</div><div class="line"></div><div class="line">-#!/bin/sh</div><div class="line">ssh root@remote서버ip &lt;&lt;EOF</div><div class="line"> cd /root/nodejs-skeletone-v2</div><div class="line"> npm install --production</div><div class="line"> pm2 start bin/www.js --name apiServer</div><div class="line"> exit</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<ol>
<li>git push event hook을 받은 jenkins가 test를 수행할것이므로 패키지를 설치한다</li>
<li>mocha test framework 를 사용하여 프로젝트 test를 진행한다.</li>
<li>scp 로 remote 서버로 프로젝트를 전송할 준비작업으로, test를 마친 jenkins가 프로젝트 패키지를 모두 삭제한다. (remote 서버에서는 서비스에 필요한 패키지만 필요하므로)</li>
<li>EOF 를 사용하여 remote 서버로 접속후 이미 실행되고있는 nodejs 서버를 중지 한다 .</li>
<li>서비스되고있는 프로젝트를 삭제한다</li>
<li>jenkins에서 방금 test를 수행한 프로젝트를 remote 서버로 프로젝트 전송을 시작한다.</li>
<li>EOF로 remote 서버로 재접속 한후, 서비스에 필요한 패키지만 받는다(–production)</li>
<li>pm2를 사용하여 서비스를 시작한다.</li>
</ol>
<p>Managed script file 작성이 끝나면 마지막으로 jenkins에 설정정보를 추가한다.<br>[ Build - managed script]<br><img src="jenkins-3_1.png" alt="jenkins-3_1"><br><br><br></p>
<h2 id="왜-SCP를-사용하는가"><a href="#왜-SCP를-사용하는가" class="headerlink" title="왜 SCP를 사용하는가"></a>왜 SCP를 사용하는가</h2><p><a href="https://setyourmindpark.github.io/2017/04/22/jenkins-2/" target="_blank" rel="noopener">jenkins로 nodejs 서버 배포하기 -  1</a> 포스트에서는 쉘스크립트 EOF를 사용하여 remote 서버에 jenkins가 접속하여 git clone명령어를 수행하고 프로젝트 서비스하는 방법이었다.<br>그렇다면 결론적으로 remote 서버에서는 git clone 명령어로 프로젝트를 받든, jenkins가 scp를 사용하여 프로젝트를 보내주든, 결국 서비스할 프로젝트는 동일하다 .<br>하지만 필자가 생각하기엔 첫번째 방법에서는 시간차로인한 문제점이 있었다. 다음과 같은 시나리오를 생각해보자.</p>
<ol>
<li>개발자가 git push를 수행하여 jenkins가 git push event hook을 받았다.</li>
<li>jenkins가 test 를 수행한다.</li>
<li>jenkins가 test를 수행하는도중 또 다른 개발자가 git push 를 수행하였다.</li>
<li>test를 마친 jenkins가 remote 서버에 접속한다.</li>
<li>jenkins에서 test 를 거치지않은 방금 또다른 개발자가 push 한 git project를 clone한다.</li>
<li>결론적으로 jenkins에서 수행한 test는 수행할 필요가 없어지게되었다.(시간차로 인한 프로젝트 불일치)</li>
</ol>
<p>물론 또다른 개발자가 push 한 프로젝트는 jenkins에서 push event hook을 받아 배포를 또다시 수행할테지만, 짧은 시간이나마 remote 서버에 배포된 프로젝트가 오류가 있었다면 서버가 죽게될것이다.(test 과정을 거치지않았기때문)<br>이러한 이유로 필자는 scp를 사용하여 프로젝트를 전송하는 방법을 생각하였다. scp를 사용하면 jenkins에서 test를 수행한 프로젝트를 remote 서버에 프로젝트를 보내기때문에 프로젝트 일관성이 보장되어 위와같은 시나리오는 막을수있다.<br><br><br></p>
<h2 id="또다른-이점"><a href="#또다른-이점" class="headerlink" title="또다른 이점"></a>또다른 이점</h2><p><a href="https://setyourmindpark.github.io/2017/04/22/jenkins-2/" target="_blank" rel="noopener">jenkins로 nodejs 서버 배포하기 -  1</a> 에서는 remote 서버에서 git clone을 받기에 github에 remote 서버 rsa public key를 등록하였다. 하지만 jenkins에서 scp를 사용하여 프로젝트를 전송하면 이런 과정이 필요없어지게되어 remote 서버에서 rsa 키를 생성할 필요도 없어지게되었고 github에 remote 서버 public key를 등록할 필요도 없어지게되었다.<br><br><br></p>
<h2 id="견해"><a href="#견해" class="headerlink" title="견해"></a>견해</h2><p><a href="https://setyourmindpark.github.io/2017/04/22/jenkins-2/" target="_blank" rel="noopener">jenkins로 nodejs 서버 배포하기 -  1</a> 와 같이 jenkins가 test 를 수행후 remote 서버에 배포를하는 결과는 동일하다.<br>첫번째방법 remote 서버에서 git clone하여 수행하는 방법은 여러개발자로 인해 빈번하게 push event가 일어나면 위에서 언급한 시간차로인한 프로젝트 불일치 현상이 생길수있는 문제점이므로, 정해진시간(주로 새벽에)에 jenkins가 remote 서버로 배포를 수행한다면 문제가되지않을것이다.(Poll SCM schedule)<br>이렇게 nodejs 서버를 remote 서버로 배포하는 2가지 방법에대해서 알아보았다.<br>또 다른 방법이 분명 있을것이고, 좀더 좋은 방법을 새롭게 알게된다면 새롭게 포스트를 올리도록 하겠다.</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2017/04/29/nodejs-2/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2017/04/22/jenkins-2/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
    <h2 class="title">留言</h2>

    
    <div id="disqus_thread" class="ds-thread">
        <script type="text/javascript">
            /**
             * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
                /*
                 var disqus_config = function () {
                 this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                 this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                 };
                 */
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = '//https-setyourmindpark-github-io.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
    </div>
    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2017-04-23 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/jenkins/">jenkins<span>5</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->

<script type="text/javascript">
var disqus_shortname = 'https-setyourmindpark-github-io';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



	</div>
  </div>
  <div class="container-narrow">
  <footer> Copyright
<p>
  &copy; 2018 jaehunpark
  
</p>
<!-- <p>
  &copy; 2018 jaehunpark
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p> -->
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
