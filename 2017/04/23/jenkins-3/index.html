<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">

  <!-- PACE Progress Bar START -->
  
    <script src="/js/pace.min.js"></script>
    <link rel="stylesheet" href="https://github.com/HubSpot/pace/raw/master/themes/orange/pace-theme-flash.css">
  
  

  <!-- PACE Progress Bar START -->

  
  <title>jenkins로 배포하기 - nodejs-2 | </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta name="description" content="jenkins로 nodejs 서버 배포하기 -  2이전 포스트 jenkins로 nodejs 서버 배포하기 -  1 를 통해 nodejs 서버를 remote 서버로 쉘스크립트 EOF를 사용하여 remote 서버에서 git clone 하여 배포하는 법을 알아보았다.이번 포스트에서는 두번째방법으로 첫번째 방법보다는 좀더 간단한 방법을 소개하려한다. 쉘 스크립트">
<meta property="og:type" content="article">
<meta property="og:title" content="jenkins로 배포하기 - nodejs-2">
<meta property="og:url" content="https://setyourmindpark.github.io/2017/04/23/jenkins-3/index.html">
<meta property="og:site_name">
<meta property="og:description" content="jenkins로 nodejs 서버 배포하기 -  2이전 포스트 jenkins로 nodejs 서버 배포하기 -  1 를 통해 nodejs 서버를 remote 서버로 쉘스크립트 EOF를 사용하여 remote 서버에서 git clone 하여 배포하는 법을 알아보았다.이번 포스트에서는 두번째방법으로 첫번째 방법보다는 좀더 간단한 방법을 소개하려한다. 쉘 스크립트">
<meta property="og:image" content="https://setyourmindpark.github.io/2017/04/23/jenkins-3/jenkins-3_2.png">
<meta property="og:image" content="https://setyourmindpark.github.io/2017/04/23/jenkins-3/jenkins-3_1.png">
<meta property="og:updated_time" content="2018-02-05T10:59:10.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="jenkins로 배포하기 - nodejs-2">
<meta name="twitter:description" content="jenkins로 nodejs 서버 배포하기 -  2이전 포스트 jenkins로 nodejs 서버 배포하기 -  1 를 통해 nodejs 서버를 remote 서버로 쉘스크립트 EOF를 사용하여 remote 서버에서 git clone 하여 배포하는 법을 알아보았다.이번 포스트에서는 두번째방법으로 첫번째 방법보다는 좀더 간단한 방법을 소개하려한다. 쉘 스크립트">
<meta name="twitter:image" content="https://setyourmindpark.github.io/2017/04/23/jenkins-3/jenkins-3_2.png">
  
    <link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >
  

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/my.css">
  <!-- Google Adsense -->
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "",
          enable_page_level_ads: true
      });
  </script>
</head>

<script>
var themeMenus = {};

  themeMenus["/"] = "Home"; 

  themeMenus["/archives"] = "Archives"; 

  themeMenus["/categories"] = "Categories"; 

</script>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="" rel="home">  </a>
            
          </h1>

          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">Categories</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>


  <div id="originBgDiv" style="background: #fff; width: 100%;">

      <div style="max-height:600px; overflow: hidden;  display: flex; display: -webkit-flex; align-items: center;">
        <img id="originBg" width="100%" alt="" src="">
      </div>

  </div>

  <script>
  function setAboutIMG(){
      var imgUrls = "css/images/pose.jpg,https://source.unsplash.com/collection/954550/1920x1080".split(",");
      var random = Math.floor((Math.random() * imgUrls.length ));
      if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
        document.getElementById("originBg").src=imgUrls[random];
      } else {
        document.getElementById("originBg").src='/' + imgUrls[random];
      }
  }
  bgDiv=document.getElementById("originBgDiv");
  if(location.pathname.match('about')){
    setAboutIMG();
    bgDiv.style.display='block';
  }else{
    bgDiv.style.display='none';
  }
  </script>



  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-jenkins-3" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      jenkins로 배포하기 - nodejs-2
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2017/04/23/jenkins-3/" class="article-date">
		<!-- <time datetime="2017-04-23T04:35:25.000Z" itemprop="datePublished">April 23, 2017</time> -->
		<time datetime="2017-04-23T04:35:25.000Z" itemprop="datePublished">2017/04/23</time>	
	</a>

      
	<span id="busuanzi_container_page_pv">
		<!-- 本文总阅读量<span id="busuanzi_value_page_pv"></span>次 -->		
	</span>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="jenkins로-nodejs-서버-배포하기-2"><a href="#jenkins로-nodejs-서버-배포하기-2" class="headerlink" title="jenkins로 nodejs 서버 배포하기 -  2"></a>jenkins로 nodejs 서버 배포하기 -  2</h2><p>이전 포스트 <a href="https://setyourmindpark.github.io/2017/04/22/jenkins-2/">jenkins로 nodejs 서버 배포하기 -  1</a> 를 통해 nodejs 서버를 remote 서버로 쉘스크립트 EOF를 사용하여 remote 서버에서 git clone 하여 배포하는 법을 알아보았다.<br>이번 포스트에서는 두번째방법으로 첫번째 방법보다는 좀더 간단한 방법을 소개하려한다.<br><br><br></p>
<h2 id="쉘-스크립트-EOF-와-SCP"><a href="#쉘-스크립트-EOF-와-SCP" class="headerlink" title="쉘 스크립트 EOF 와 SCP"></a>쉘 스크립트 EOF 와 SCP</h2><p>기본적으로 쉘스크립트 EOF를 사용하여 jenkins가 remote 서버에서 control하는 기본 개념은 같다.<br>이후 첫번째방법에서는 jenkins가 remote 서버 접속후 프로젝트를 다시 clone 하여 job을 수행하는 방법이었으며, 이번에 소개해드릴방법은 jenkins가 test를 수행한 프로젝트 자체를 scp 명령어를 사용해서 remote 서버로 프로젝트를 전송하는 방법이다 .<br>jenkins [ Managed script file ] 플러그인을 다음과 같이 설정하였다.<br>jenkins관리 -&gt; Managed files -&gt; Add a new Config -&gt; Managed script file<br><img src="jenkins-3_2.png" alt="jenkins-3_2"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">npm install</div><div class="line">npm test</div><div class="line">rm -rf node_modules</div><div class="line"></div><div class="line">-#!/bin/sh</div><div class="line">ssh root@remote서버ip &lt;&lt;EOF</div><div class="line"> pm2 delete apiServer</div><div class="line"> rm -rf /root/nodejs-skeletone-v2</div><div class="line"> exit</div><div class="line">EOF</div><div class="line"></div><div class="line">scp -r ../nodejs-skeletone-v2 root@remote서버ip:/root</div><div class="line"></div><div class="line">-#!/bin/sh</div><div class="line">ssh root@remote서버ip &lt;&lt;EOF</div><div class="line"> cd /root/nodejs-skeletone-v2</div><div class="line"> npm install --production</div><div class="line"> pm2 start bin/www.js --name apiServer</div><div class="line"> exit</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<ol>
<li>git push event hook을 받은 jenkins가 test를 수행할것이므로 패키지를 설치한다</li>
<li>mocha test framework 를 사용하여 프로젝트 test를 진행한다.</li>
<li>scp 로 remote 서버로 프로젝트를 전송할 준비작업으로, test를 마친 jenkins가 프로젝트 패키지를 모두 삭제한다. (remote 서버에서는 서비스에 필요한 패키지만 필요하므로)</li>
<li>EOF 를 사용하여 remote 서버로 접속후 이미 실행되고있는 nodejs 서버를 중지 한다 .</li>
<li>서비스되고있는 프로젝트를 삭제한다</li>
<li>jenkins에서 방금 test를 수행한 프로젝트를 remote 서버로 프로젝트 전송을 시작한다.</li>
<li>EOF로 remote 서버로 재접속 한후, 서비스에 필요한 패키지만 받는다(–production)</li>
<li>pm2를 사용하여 서비스를 시작한다.</li>
</ol>
<p>Managed script file 작성이 끝나면 마지막으로 jenkins에 설정정보를 추가한다.<br>[ Build - managed script]<br><img src="jenkins-3_1.png" alt="jenkins-3_1"><br><br><br></p>
<h2 id="왜-SCP를-사용하는가"><a href="#왜-SCP를-사용하는가" class="headerlink" title="왜 SCP를 사용하는가"></a>왜 SCP를 사용하는가</h2><p><a href="https://setyourmindpark.github.io/2017/04/22/jenkins-2/">jenkins로 nodejs 서버 배포하기 -  1</a> 포스트에서는 쉘스크립트 EOF를 사용하여 remote 서버에 jenkins가 접속하여 git clone명령어를 수행하고 프로젝트 서비스하는 방법이었다.<br>그렇다면 결론적으로 remote 서버에서는 git clone 명령어로 프로젝트를 받든, jenkins가 scp를 사용하여 프로젝트를 보내주든, 결국 서비스할 프로젝트는 동일하다 .<br>하지만 필자가 생각하기엔 첫번째 방법에서는 시간차로인한 문제점이 있었다. 다음과 같은 시나리오를 생각해보자.</p>
<ol>
<li>개발자가 git push를 수행하여 jenkins가 git push event hook을 받았다.</li>
<li>jenkins가 test 를 수행한다.</li>
<li>jenkins가 test를 수행하는도중 또 다른 개발자가 git push 를 수행하였다.</li>
<li>test를 마친 jenkins가 remote 서버에 접속한다.</li>
<li>jenkins에서 test 를 거치지않은 방금 또다른 개발자가 push 한 git project를 clone한다.</li>
<li>결론적으로 jenkins에서 수행한 test는 수행할 필요가 없어지게되었다.(시간차로 인한 프로젝트 불일치)</li>
</ol>
<p>물론 또다른 개발자가 push 한 프로젝트는 jenkins에서 push event hook을 받아 배포를 또다시 수행할테지만, 짧은 시간이나마 remote 서버에 배포된 프로젝트가 오류가 있었다면 서버가 죽게될것이다.(test 과정을 거치지않았기때문)<br>이러한 이유로 필자는 scp를 사용하여 프로젝트를 전송하는 방법을 생각하였다. scp를 사용하면 jenkins에서 test를 수행한 프로젝트를 remote 서버에 프로젝트를 보내기때문에 프로젝트 일관성이 보장되어 위와같은 시나리오는 막을수있다.<br><br><br></p>
<h2 id="또다른-이점"><a href="#또다른-이점" class="headerlink" title="또다른 이점"></a>또다른 이점</h2><p><a href="https://setyourmindpark.github.io/2017/04/22/jenkins-2/">jenkins로 nodejs 서버 배포하기 -  1</a> 에서는 remote 서버에서 git clone을 받기에 github에 remote 서버 rsa public key를 등록하였다. 하지만 jenkins에서 scp를 사용하여 프로젝트를 전송하면 이런 과정이 필요없어지게되어 remote 서버에서 rsa 키를 생성할 필요도 없어지게되었고 github에 remote 서버 public key를 등록할 필요도 없어지게되었다.<br><br><br></p>
<h2 id="견해"><a href="#견해" class="headerlink" title="견해"></a>견해</h2><p><a href="https://setyourmindpark.github.io/2017/04/22/jenkins-2/">jenkins로 nodejs 서버 배포하기 -  1</a> 와 같이 jenkins가 test 를 수행후 remote 서버에 배포를하는 결과는 동일하다.<br>첫번째방법 remote 서버에서 git clone하여 수행하는 방법은 여러개발자로 인해 빈번하게 push event가 일어나면 위에서 언급한 시간차로인한 프로젝트 불일치 현상이 생길수있는 문제점이므로, 정해진시간(주로 새벽에)에 jenkins가 remote 서버로 배포를 수행한다면 문제가되지않을것이다.(Poll SCM schedule)<br>이렇게 nodejs 서버를 remote 서버로 배포하는 2가지 방법에대해서 알아보았다.<br>또 다른 방법이 분명 있을것이고, 좀더 좋은 방법을 새롭게 알게된다면 새롭게 포스트를 올리도록 하겠다.</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/jenkins/">jenkins</a>

      
      
            
      
        
	<section id="comments" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'https-setyourmindpark-github-io';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>


      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/04/29/nodejs-2/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Promise ReactiveX
        
      </div>
    </a>
  
  
    <a href="/2017/04/22/jenkins-2/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">jenkins로 배포하기 - nodejs-1</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#jenkins로-nodejs-서버-배포하기-2"><span class="nav-number">1.</span> <span class="nav-text">jenkins로 nodejs 서버 배포하기 -  2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#쉘-스크립트-EOF-와-SCP"><span class="nav-number">2.</span> <span class="nav-text">쉘 스크립트 EOF 와 SCP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#왜-SCP를-사용하는가"><span class="nav-number">3.</span> <span class="nav-text">왜 SCP를 사용하는가</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#또다른-이점"><span class="nav-number">4.</span> <span class="nav-text">또다른 이점</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#견해"><span class="nav-number">5.</span> <span class="nav-text">견해</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2018 jaehunpark All Rights Reserved.
          
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var contentdiv = document.getElementById("content");

    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

<!-- Custome JS -->
<script src="/js/my.js"></script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-97011652-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->







	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
