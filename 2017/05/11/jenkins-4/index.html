<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>ssh scp proxy | </title>
  <meta name="author" content="jaehunpark">
  
  <meta name="description" content="ssh scp필자는 jenkins를 주로 사용하며 빌드는 nodejs 기반의 서버를 배포시에는 ssh 와 scp 를 주로사용한다 .ssh와 scp를 사용하는데에 있어 최종 서버에 접근하기까지 중간에 bridge( jump host )와 같은 host가 존재할때가 있다 ">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="ssh scp proxy"/>
  <meta property="og:site_name" content=""/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-97011652-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/"></a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> ssh scp proxy</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h2 id="ssh-scp"><a href="#ssh-scp" class="headerlink" title="ssh scp"></a>ssh scp</h2><p>필자는 jenkins를 주로 사용하며 빌드는 nodejs 기반의 서버를 배포시에는 ssh 와 scp 를 주로사용한다 .<br>ssh와 scp를 사용하는데에 있어 최종 서버에 접근하기까지 중간에 bridge( jump host )와 같은 host가 존재할때가 있다 .<br>물론 접근하고자하는 서버의 ip를 모두 public 으로 개방하면 쉽게 접근이가능하나 관리가 어려워질뿐만아니라 보안적으로도 좋지않기때문에 public host가 proxy host가 되어 내부 서버로 접근해야한다.<br>필자는 jenkins로 빌드할때 이런 상황이 있었으며 정리를하며 기록으로 남기기위해 글을써보려 한다 .<br><br><br></p>
<h2 id="사전준비"><a href="#사전준비" class="headerlink" title="사전준비"></a>사전준비</h2><p>필자는 기본적으로 jenkins 를 사용하여 원격지에 배포하므로 원격서버 접속시 jenkins 에게 비밀번호를 요구하지 않도록 rsa 암호화통신을 위한 사전 설정한다 .</p>
<h3 id="jenkins"><a href="#jenkins" class="headerlink" title="jenkins"></a>jenkins</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat ~/.ssh/id_rsa.pub</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="proxy-host"><a href="#proxy-host" class="headerlink" title="proxy host"></a>proxy host</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ vi ~/.ssh/authorized_keys</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="destination-host"><a href="#destination-host" class="headerlink" title="destination host"></a>destination host</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ vi ~/.ssh/authorized_keys</div></pre></td></tr></table></figure>
<p><br></p>
<p>jenkins 에서 cat 명령어로 출력된 id_rsa.pub ( public key ) 를 proxy host 와 최종 접속할 destination host 의 ~/.ssh/authorized_keys 에 붙여넣기한다.<br>작업을 마치게되면 jenkins는 proxy host를 거쳐 destination host 에 비밀번호없이 직접적으로 접근이 가능해졌다.<br><br><br></p>
<h2 id="ssh-scp-일반적인-사용"><a href="#ssh-scp-일반적인-사용" class="headerlink" title="ssh scp 일반적인 사용"></a>ssh scp 일반적인 사용</h2><p>기본적으로 proxy host를 사용하지않고 단일 remote host ssh 와 scp 는 다음과같다.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh &lt;계정&gt;@&lt;remote host ip&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scp -r &lt;전송할 파일/폴더&gt; &lt;계정&gt;@&lt;remote host ip&gt;:&lt;remote host에 전송받을 경로&gt;</div></pre></td></tr></table></figure>
<p>이제 proxy host를 경유하여 destination host에 ssh scp 사용법을 알아보자 .</p>
<p><br><br></p>
<h2 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h2><p>필자의 접속 정보는 다음과 같다 . (예시)<br>proxy host : 121.140.166.90<br>destination host : 10.10.200.3</p>
<h3 id="manual-proxy"><a href="#manual-proxy" class="headerlink" title="manual proxy"></a>manual proxy</h3><h4 id="기본적인방법"><a href="#기본적인방법" class="headerlink" title="기본적인방법"></a>기본적인방법</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh -tt jaehunpark@121.140.166.90 ssh root@10.10.200.3</div></pre></td></tr></table></figure>
<p>아주 간단하게 쓸수있는방법이다 .<br>단순히 -tt 옵션과 ssh 명령어를 두번적어주면된다.<br>하지만 추가적인 설정이 필요하다. 위의 명령어는 proxy host( 121.140.166.90 )로 접속후 proxy host가 destincation host( 10.10.200.3 ) 로 접속을 시도하므로  proxy host의 id_rsa.pub (public key)가 destination host 의 ~/.ssh/authorized_keys 에 존재해야 호출하는 머신에서 direct로 접근가능하다.<br>결론적으로 destination host의 authorized_keys 에는 jenkins host의 id_rsa.pub 와 proxy host id_rsa.pub 두개가 존재해야한다 .<br>( jenkins를 사용하지않고 일반적으로 접속하시는것이라면 그냥 비밀번호 치셔도 됩니다 )</p>
<p><br></p>
<h4 id="proxycommand-사용"><a href="#proxycommand-사용" class="headerlink" title="proxycommand 사용"></a>proxycommand 사용</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh -o ProxyCommand=&quot;ssh -W %h:%p jaehunpark@121.140.166.90&quot; root@10.10.200.3</div></pre></td></tr></table></figure>
<p>proxy host를 통하여 직접적으로 접근하는 proxycommand를 사용한 방법이다<br><br></p>
<h3 id="proxy-after-configuration"><a href="#proxy-after-configuration" class="headerlink" title="proxy after configuration"></a>proxy after configuration</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh server-node-1</div></pre></td></tr></table></figure>
<p>하단의 <code>configuration</code> 탭의 설정을 마친후 proxy host를 거쳐 destination host에 접근하는 명령어이다.<br>설정만 잘 해놓는다면 정말 간단하게 접근할수있다.<br><br><br></p>
<h2 id="scp"><a href="#scp" class="headerlink" title="scp"></a>scp</h2><h3 id="manual-proxy-1"><a href="#manual-proxy-1" class="headerlink" title="manual proxy"></a>manual proxy</h3><h4 id="첫번째방법"><a href="#첫번째방법" class="headerlink" title="첫번째방법"></a>첫번째방법</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scp -r -o ProxyCommand=&quot;ssh jaehunpark@121.140.166.90 nc 10.10.200.3 22&quot; /root/.jenkins/workspace/nodejs-skeletone-v2 root@10.10.200.3:/root</div></pre></td></tr></table></figure>
<p><br></p>
<h4 id="두번째방법"><a href="#두번째방법" class="headerlink" title="두번째방법"></a>두번째방법</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scp -r -o ProxyCommand=&quot;ssh -W %h:%p jaehunpark@121.140.166.90&quot; /root/.jenkins/workspace/nodejs-skeletone-v2 root@10.10.200.3:/root</div></pre></td></tr></table></figure>
<p>첫번째방법과 두번째방법 scp 역시 ssh와 비슷하게 proxycommand 를 사용하여 파일을 전송한다. 명령어가 길다보니 조금은 지저분한 느낌이다 . 아래와같이 간단하게 사용할수있다<br><br></p>
<h3 id="proxy-after-configuration-1"><a href="#proxy-after-configuration-1" class="headerlink" title="proxy after configuration"></a>proxy after configuration</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scp -r nodejs-skeletone-v2 server-node-1:/root</div></pre></td></tr></table></figure>
<p>ssh와 마찬가지로 <code>configuration</code> 탭의 설정을 마친후 proxy host 를 거쳐 destination host 로 파일을 전송한다<br><br><br></p>
<h2 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ vi ~/.ssh/config</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Host server-node-1</div><div class="line">HostName 10.10.200.3</div><div class="line">User root</div><div class="line">IdentityFile ~/.ssh/id_rsa</div><div class="line">ProxyCommand ssh -W 10.10.200.3:22 jaehunpark@121.140.166.90</div></pre></td></tr></table></figure>
<p><br><br></p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><p>proxy host 를 거쳐 destination host 로 ssh 나 scp 를 최초사용시에는 아래와같은 문구를 만나게될것이다.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@467c66252dcd:~/.ssh# ssh server-node-1</div><div class="line">Warning: Permanently added &apos;121.140.166.90&apos; (ECDSA) to the list of known hosts.</div><div class="line">The authenticity of host &apos;10.10.200.3 (&lt;no hostip for proxy command&gt;)&apos; can&apos;t be established.</div><div class="line">ECDSA key fingerprint is 88:65:92:d8:f8:75:b4:99:1a:f1:52:e8:b2:03:0e:a6.</div><div class="line">Are you sure you want to continue connecting (yes/no)?</div></pre></td></tr></table></figure></p>
<p>최초 접속시에는 ~/.ssh/known_hosts 접속 정보가 존재하지 않기 때문에 연결여부를 물어본후 ‘yes’ 를 입력하게되면 ~/.ssh/known_hosts 에 등록하게된다 .<br>개발자가 배포설정을 마치고 jenkins에게 빌드를 시작할때 jenkins는 최초접속이므로 접속정보가 존재하지않아 위의 문구를 만나게되면 가차없이 build fail이 떨어질것이다 .<br>또한 현재 세팅상태로는 proxy host와 destination host 두개의 host 정보가 등록되지않아 두번 요구하게될것이다 .<br>사전에 다음과같이 해결할수있다 .</p>
<h3 id="jenkins-1"><a href="#jenkins-1" class="headerlink" title="jenkins"></a>jenkins</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh-keyscan -H 121.140.166.90 &gt;&gt; ~/.ssh/known_hosts</div></pre></td></tr></table></figure>
<p>proxy host ip를 known_hosts를 등록한후<br><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ vi ~/.ssh/config</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Host server-node-1</div><div class="line">StrictHostKeyChecking no</div><div class="line">HostName 10.10.200.3</div><div class="line">User root</div><div class="line">IdentityFile ~/.ssh/id_rsa</div><div class="line">ProxyCommand ssh -W 10.10.200.3:22 jaehunpark@121.140.166.90</div></pre></td></tr></table></figure>
<p><code>StrictHostKeyChecking no</code> 를 추가하여 destination host ( 10.10.200.3 ) 의 접속여부를 무시한다 . ( auto yes )<br><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh server-node-1</div></pre></td></tr></table></figure></p>
<p>최초접속이라도 어떠한 요구도 묻지않고 proxy host를 거쳐 destination host로 접속할수있다 . ( 위의 설정을 마치고나게되면 known_hosts 에 등록되게된다 )</p>
<!-- ssh -o ProxyCommand="ssh -W %h:%p jaehunpark@121.140.166.90" root@10.10.200.3
scp -r -o ProxyCommand="ssh -W %h:%p jaehunpark@121.140.166.90" id_rsa root@10.10.200.3:/
scp -r -o ProxyCommand="ssh jaehunpark@121.140.166.90 nc 10.10.200.3 22" id_rsa root@10.10.200.3:/ -->
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2017/05/13/nodejs-3/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Anterior</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2017/05/04/nginx-1/" type="button" class="btn btn-default ">Próximo<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
    <h2 class="title">Comentários</h2>

    
    <div id="disqus_thread" class="ds-thread">
        <script type="text/javascript">
            /**
             * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
                /*
                 var disqus_config = function () {
                 this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                 this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                 };
                 */
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = '//https-setyourmindpark-github-io.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
    </div>
    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2017-05-11 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/jenkins/">jenkins<span>5</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->

<script type="text/javascript">
var disqus_shortname = 'https-setyourmindpark-github-io';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



	</div>
  </div>
  <div class="container-narrow">
  <footer> Copyright
<p>
  &copy; 2018 jaehunpark
  
</p>
<!-- <p>
  &copy; 2018 jaehunpark
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p> -->
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
